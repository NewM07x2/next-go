# Dockerfile 解説

## Dockerfile.backend

このファイルはバックエンド（Goアプリケーション）のDockerイメージを構築するためのものです。

### バックエンドの内容

- **ベースイメージ**: `golang:1.20` を使用。
- **作業ディレクトリ**: `/app`。
- **依存関係のインストール**: `go mod tidy` を実行して依存関係を整理。
- **ビルド**: `go build` を使用してアプリケーションをビルド。
- **エントリポイント**: ビルドされたバイナリ `main` を実行。

---

## Dockerfile.frontend

このファイルはフロントエンド（Next.jsアプリケーション）のDockerイメージを構築するためのものです。

### フロントエンドの内容

- **ベースイメージ**: `node:18` を使用。
- **作業ディレクトリ**: `/app`。
- **依存関係のインストール**: `npm install` を実行して必要なパッケージをインストール。
- **ソースコードのコピー**: プロジェクト全体をコンテナ内にコピー。
- **ポート公開**: `3000` 番ポートを公開。
- **エントリポイント**: `npm run dev` を実行して開発サーバーを起動。

---

## Dockerfileの基本構造と見方

Dockerfileは、Dockerイメージを作成するための指示を記述したファイルです。以下に基本構造と見方を説明します。

### 基本構造

1. **ベースイメージの指定**

   ```dockerfile
   FROM <イメージ名>:<タグ>
   ```
   - 使用するベースイメージを指定します。
   - 例: `FROM node:18` はNode.jsのバージョン18をベースにすることを意味します。

2. **作業ディレクトリの設定**
   ```dockerfile
   WORKDIR <ディレクトリ名>
   ```
   - コンテナ内での作業ディレクトリを指定します。
   - 以降のコマンドはこのディレクトリを基準に実行されます。

3. **ファイルのコピー**
   ```dockerfile
   COPY <コピー元> <コピー先>
   ```
   - ホストマシンからコンテナ内にファイルをコピーします。
   - 例: `COPY package*.json ./` は、`package.json` と `package-lock.json` をコンテナ内にコピーします。

4. **依存関係のインストール**
   ```dockerfile
   RUN <コマンド>
   ```
   - コンテナ内でコマンドを実行します。
   - 例: `RUN npm install` はNode.jsの依存関係をインストールします。

5. **ポートの公開**
   ```dockerfile
   EXPOSE <ポート番号>
   ```
   - コンテナが使用するポートを指定します。
   - 例: `EXPOSE 3000` は3000番ポートを公開します。

6. **エントリポイントの設定**
   ```dockerfile
   CMD ["コマンド", "引数"]
   ```
   - コンテナ起動時に実行されるコマンドを指定します。
   - 例: `CMD ["npm", "run", "dev"]` は開発サーバーを起動します。

### Dockerfileを見る際のポイント

1. **ベースイメージの確認**
   - 使用しているベースイメージが適切かどうかを確認します。

2. **依存関係のインストール**
   - 必要な依存関係が正しくインストールされているかを確認します。

3. **ファイルのコピー**
   - 必要なファイルが正しくコンテナ内にコピーされているかを確認します。

4. **エントリポイント**
   - コンテナ起動時に実行されるコマンドが正しいかを確認します。

---

## 補足

### 作業ディレクトリ `/app` について

`/app` は、Dockerコンテナ内で設定される作業ディレクトリ（ワーキングディレクトリ）です。

#### 詳細

- **作業ディレクトリとは**
  Dockerfile内で `WORKDIR` 指令を使用して指定されたディレクトリです。このディレクトリは、以降のすべてのコマンド（例: `COPY`, `RUN`, `CMD` など）が実行される基準となる場所です。

- **`WORKDIR /app` の意味**
  コンテナ内に `/app` というディレクトリを作成し、以降の操作（ファイルのコピーやコマンドの実行など）がこのディレクトリ内で行われるように設定しています。

- **実際の場所**
  `/app` はコンテナ内の仮想的なディレクトリであり、ホストマシン（あなたのPC）のディレクトリとは異なります。例えば、ホストの `./go-app` ディレクトリがコンテナ内の `/app` にマウントされる設定が `docker-compose.yml` で行われている場合、ホストの `./go-app` の内容が `/app` に反映されます。

`docker-compose.yml` の `volumes` セクションを確認することで、具体的なマウント設定を確認できます。

これらのDockerfileは、`docker-compose.yml`を通じてそれぞれのサービスに対応しています。

---

## Dockerの操作コマンド（コマンドサマリ）

以下は日常的によく使うコマンドに絞った簡潔なサマリです。破壊的なコマンドには注意書きを付けています。

### 起動

```bash
# docker-composeを使ってイメージを再ビルドし、バックグラウンドで起動
docker-compose up --build -d
```

- `--build`: 必要に応じてイメージを再ビルドします。
- `-d`: バックグラウンドでコンテナを起動します。

```bash
# 単一コンテナをイメージから起動する例
docker run -d --name myapp -p 3000:3000 <イメージ名>
```

- `-p ホスト:コンテナ` でポートマッピングを行います。

### 停止

```bash
# 実行中のコンテナを停止
docker stop <コンテナID|コンテナ名>
```

```bash
# docker-composeで立ち上げたサービス群を停止・削除（ネットワークは削除される）
docker-compose down
```

- `docker-compose down` はコンテナとネットワークを削除します。ボリュームやイメージを同時に削除するオプションの具体例と注意点は以下の通りです。

```bash
# デフォルト: コンテナとネットワークのみを停止・削除
docker-compose down
```

```bash
# コンテナ・ネットワークに加え、関連付けられたボリュームも削除（永続データが失われます）
docker-compose down --volumes
# 短縮形: docker-compose down -v
```

```bash
# コンテナ・ネットワークに加え、Composeで作成されたイメージを削除（--rmi all）
docker-compose down --rmi all
```

```bash
# ボリュームとイメージの両方を削除する完全クリーン
docker-compose down --rmi all --volumes
```

- 注意:
  - `--volumes` は Compose の named volumes や自動作成されたボリュームを削除しますが、ホストの bind マウント（例: ホストパスをマウントしたもの）は削除されません。
  - `--rmi all` を付けるとイメージが削除されるため、再度起動する場合はイメージの再ビルド（`docker-compose build` など）が必要になります。
  - いずれのオプションも不可逆なので、実行前に `docker ps -a` / `docker volume ls` / `docker images` 等で影響範囲を確認してください。

### 一覧表示

```bash
# 実行中のコンテナのみ表示（停止済みも含める場合は -a を追加）
docker ps
```

```bash
# ローカルにあるイメージを表示
docker images
```

```bash
# ボリューム一覧
docker volume ls
```

```bash
# ネットワーク一覧
docker network ls
```

### 削除 / クリーンアップ

```bash
# 停止済みのコンテナを削除
docker rm <コンテナID|コンテナ名>
```

```bash
# イメージを削除
docker rmi <イメージID|イメージ名>
```

```bash
# 未使用（danglingではなく）ボリュームをまとめて削除
docker volume prune
```

```bash
# 未使用のネットワークをまとめて削除
docker network prune
```

```bash
# システム全体の未使用リソースを一括削除（イメージは -a で未使用の全イメージを削除）
# ※ デフォルトではボリュームは削除されません。ボリュームも削除する場合は --volumes を追加します。
docker system prune -a
```

- 重要: `docker system prune -a` や `docker volume prune` は不可逆です。実行前に `docker ps -a` / `docker images` / `docker volume ls` などで影響範囲を確認してください。

### 補助コマンド（よく使う）

```bash
# リアルタイムでコンテナのログを追う
docker logs -f <コンテナID|コンテナ名>
```

```bash
# コンテナ内でコマンドを実行（対話シェル）
docker exec -it <コンテナID|コンテナ名> /bin/sh
# もしくは /bin/bash（イメージにbashが入っている場合）
```

```bash
# コンテナやイメージの詳細情報を表示
docker inspect <コンテナID|イメージID>
```

### 状況確認（ディスク使用量など）

```bash
# Dockerが使用しているディスク容量の概観を表示
docker system df
```

---

これで重複を取り除き、起動・停止・一覧表示・削除という観点で整理しました。説明の内容（`docker system prune -a` の挙動や `docker-compose down` のボリューム挙動など）は上記の通り正確に修正済みです。